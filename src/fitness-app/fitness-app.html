<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../bower_components/paper-radio-button/paper-radio-button.html">
<link rel="import" href="../../bower_components/paper-radio-group/paper-radio-group.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../bower_components/paper-toggle-button/paper-toggle-button.html">
<link rel="import" href="../../bower_components/vaadin-date-picker/vaadin-date-picker.html">

<dom-module id="fitness-app">
  <script src="../../bower_components/highcharts/highcharts.js"></script>
  <script src="../../bower_components/jquery/dist/jquery.js"></script>
  <script src="../../bower_components/highcharts/modules/exporting.js"></script>

  <template>
    <style include="iron-flex iron-flex-alignment app-theme">
      :host {
        display: block;
      }

      .dark {
        @apply --app-dark-theme;
      }

      .light {
        @apply --app-light-theme;
      }

      #input-group {
        margin : 2vh;
      }

      paper-input {
        max-width : 300px;
      }

      paper-card {
        width      : 100%;
        margin-top : 2em;
      }

      #parent {
        transition : background-color 0.3s,  color 0.3s;
        transition-timing-function: ease-out;
      }

    </style>

    <iron-ajax id="dataIA"
               auto
               method="GET"
               url="{{ dataURL }}"
               handle-as="json"
               on-error="_responseFail"
               last-response="{{ chartData }}">
    </iron-ajax>
    <!--<div id="parent" class$="[[ _computeTheme(theme) ]]">-->
    <div id="parent" class$="[[ _computeTheme(theme) ]]">
      <div id="input-group">
        <div class="layout vertical center-justified">
          <div class="flex self-center">
            <paper-radio-group selected="{{ chartType }}">
              <paper-radio-button name="area">Area</paper-radio-button>
              <paper-radio-button name="spline">Spline</paper-radio-button>
            </paper-radio-group>
          </div>

          <div class="flex self-center">
            <!--<paper-input id="xVal" value="{{ xVal }}" placeholder="x-axis value"></paper-input>-->
            <vaadin-date-picker value="{{ xVal }}" label="Pick a date"></vaadin-date-picker>
            <paper-input value="{{ yVal }}" placeholder="y-axis value" type="number"></paper-input>
            <paper-button raised on-click="_addPoint">Add point</paper-button>
          </div>

          <div id="chartCard" class="flex stretch">
            <paper-toggle-button checked="{{ theme }}">Dark/Light theme: {{ theme }}</paper-toggle-button>
            <paper-card elevation="1"
                        preload-image
                        fade-image>
              <div class="card-content">
                <div id="container" style="min-width: 310px; height: 400px; margin: 0 auto;"></div>
              </div>
            </paper-card>
          </div>
        </div>
      </div>
    </div>
  </template>

  <script>
    /**
     * @customElement
     * @polymer
     */
    class FitnessApp extends Polymer.Element {
      static get is () {
        return 'fitness-app';
      }

      static get properties () {
        return {
          prop1 : {
            type  : String,
            value : 'fitness-app'
          },

          chartData : {
            type     : Object,
            observer : 'generateChartOptions',
            value    : function () {
              return [];
            }
          },

          chartType : {
            type     : String,
            observer : '_updateChartType',
            value    : 'area'
          },

          defaultOptions : {
            type  : Object,
            value : {
              chart       : {
                zoomType : 'xy',
                area     : true,
                spline   : false
              },
              title       : {
                text : 'USD to EUR exchange rate over time'
              },
              subtitle    : {
                text : document.ontouchstart === undefined ?
                    'Click and drag in the plot area to zoom in' : 'Pinch the chart to zoom in'
              },
              xAxis       : {
                type : 'datetime'
              },
              yAxis       : {
                title : {
                  text : 'Exchange rate'
                }
              },
              legend      : {
                enabled : true
              },
              plotOptions : {
                area : {
                  fillColor : {
                    linearGradient : {
                      x1 : 0,
                      y1 : 0,
                      x2 : 0,
                      y2 : 1
                    },
                    stops          : [
                      [ 0, Highcharts.getOptions().colors[ 0 ] ],
                      [ 1, Highcharts.Color( Highcharts.getOptions().colors[ 0 ] ).setOpacity( 0 ).get( 'rgba' ) ]
                    ]
                  },
                  marker    : {
                    radius : 2
                  },
                  lineWidth : 1,
                  states    : {
                    hover : {
                      lineWidth : 1
                    }
                  },
                  threshold : null
                }
              },

              series : [ {
                type : 'area',
                name : 'USD to EUR',
                data : this.chartData
              } ]
            }
          },

          dataURL : {
            type  : String,
            value : 'https://cdn.rawgit.com/highcharts/highcharts/v6.0.5/samples/data/usdeur.json'
          },

          options : {
            type  : Object,
            value : function () {
              return {};
            }
          },

          theme : {
            type  : String,
            value : false
          }
        };
      }

      ready () {
        super.ready();
        this.chart = undefined;
        this.xVal  = undefined;
        this.yVal  = undefined;
      }

      generateChartOptions () {
        this.defaultOptions.series[ 0 ].data = this.chartData;

        this.options = Highcharts.merge( this.defaultOptions, this.options );
        this.generateChart();
      }

      generateChart () {
        this.chart = Highcharts.chart( this.$.container, this.options );
      }

      resetOptions () {
        Highcharts.setOptions( this.defaultOptions );
      }

      _addPoint () {
        this.chart.series[ 0 ].addPoint( [ new Date( this.xVal ).getTime(), parseFloat( this.yVal ) ], true );
      }


      _computeTheme () {
        if ( this.chart ) {
          let themeA = {
                colors      : [ '#7cb5ec', '#0000FF' ],
                plotOptions : {
                  area : {
                    fillColor : {
                      linearGradient : {
                        x1 : 0,
                        y1 : 0,
                        x2 : 0,
                        y2 : 1
                      },
                      stops          : [
                        [ 0, '#7cb5ec' ],
                        [ 1, Highcharts.Color( '#7cb5ec' ).setOpacity( 0 ).get( 'rgba' ) ]
                      ]
                    }
                  }
                }
              },
              themeB = {
                colors      : [ '#070711', '#969896' ],
                plotOptions : {
                  area : {
                    fillColor : {
                      linearGradient : {
                        x1 : 0,
                        y1 : 0,
                        x2 : 0,
                        y2 : 1
                      },
                      stops          : [
                        [ 0, '#070711' ],
                        [ 1, Highcharts.Color( '#070711' ).setOpacity( 0 ).get( 'rgba' ) ]
                      ]
                    }
                  }
                }
              };

          if ( this.theme ) {
            this.options = Highcharts.merge( this.options, themeB );
          } else {
            this.options = Highcharts.merge( this.options, themeA );
          }

          Highcharts.setOptions( this.options );
          this.generateChart();
          return this.theme ? 'dark' : 'light';
        }
      }

      _updateChartType ( newVal, oldVal ) {
        this.set( 'options.chart.type', newVal );

        switch ( this.options.chart.type ) {
          case 'area':
            this.set( 'options.plotOptions', {
              area : {
                fillColor : {
                  linearGradient : {
                    x1 : 0,
                    y1 : 0,
                    x2 : 0,
                    y2 : 1
                  },
                  stops          : [
                    [ 0, Highcharts.getOptions().colors[ 0 ] ],
                    [ 1, Highcharts.Color( Highcharts.getOptions().colors[ 0 ] ).setOpacity( 0 ).get( 'rgba' ) ]
                  ]
                },
                marker    : {
                  radius : 2
                },
                lineWidth : 1,
                states    : {
                  hover : {
                    lineWidth : 1
                  }
                },
                threshold : null
              }
            } );

            if ( this.options.series && this.options.series.length ) {
              for ( let subSeries of this.options.series ) {
                subSeries.type = 'area';
              }

              this.notifyPath( 'options.series' );
            }
            break;
          case 'spline':
            this.set( 'options.plotOptions', {
              spline : {
                dataLabels : {
                  enabled : true
                }
              },
              marker : {
                enabled : true
              }
            } );

            for ( let subSeries of this.options.series ) {
              subSeries.type = 'spline';
            }

            this.notifyPath( 'options.series' );
            break;
          default:
            break;
        }

        this.generateChart();
      }

      _responseSuccess ( result ) {
        console.log( result );
      }

      _responseFail ( result ) {
        console.error( result );
      }
    }

    window.customElements.define( FitnessApp.is, FitnessApp );
  </script>
</dom-module>
